<?php/* * This file is part of the IdeaToLife package. * * (c) Youssef Jradeh <youssef.jradeh@ideatolife.me> * */namespace App\Http\Controllers\App\Project;use App\Http\Controllers\WhoController;use App\Models\ProjectMember;use App\Models\SiteReference;class SiteController extends WhoController {	/**	 *	 * @return array	 */	protected static function validationRules() {		return [			'index' => [				'project_id' => 'exists:projects,id',			],		];	}	/**	 * return the list of the sites base on the user preference.	 *	 * @return \Illuminate\Http\Response	 */	public function index()        {                $query = "";                $details = [];                $userId = empty($this->user)?request("user_id"):$this->user->id;                if ($userId>0) {                        $sites = \App\Models\ProjectLocationDetail::where("user_id", $userId)->pluck("site_id","site_id")->toArray();                        if(empty($sites)){                                $user = \App\Models\User::find($userId);                                if(!in_array($user->reporting_agency, array('none','mobile_teams')))                                    $sites = \App\Models\SurveillanceLocation::where("user_id", $userId)->pluck("site_id","site_id")->toArray();                                else                                    $sites = SiteReference::whereNotNull("governorate_id")->pluck("id","id")->toArray();                        }                        if (!empty($sites)) {                                $query = SiteReference::with(["governorate","projects","district"])->whereIn("id", $sites);                        }                }                if (!$query && request("project_id")) {                        $project = \App\Models\Project::find(request("project_id"));                        if($project->project_type == 'surveillance'){                            if($userId > 0){                                $user = \App\Models\User::find($userId);                                if(!in_array($user->reporting_agency, array('none','mobile_teams')))                                    $sites = \App\Models\SurveillanceLocation::where("user_id", $userId)->pluck("site_id","site_id")->toArray();                                else                                    $sites = SiteReference::whereNotNull("governorate_id")->pluck("id","id")->toArray();                            }else                                $sites = SiteReference::whereNotNull("governorate_id")->pluck("id","id")->toArray();                        }else                            $sites = \App\Models\ProjectLocationDetail::where("project_id", request("project_id"))->pluck("site_id","site_id")->toArray();                        $query = SiteReference::with(["governorate","projects","district"])->whereIn("id", $sites);                }                if($query != "")                {                    $data = $query->get();                    //$data['details'] = $details;                }                else                    $data = [];                return $this->successData($data);	}}